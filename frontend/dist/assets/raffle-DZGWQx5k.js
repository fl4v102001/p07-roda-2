var X=Object.defineProperty;var Z=(n,t,e)=>t in n?X(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var A=(n,t,e)=>Z(n,typeof t!="symbol"?t+"":t,e);import"./style-RTyUgtkN.js";const i={items:[],raffleTitle:"ðŸŽ¯ Roda de Sorteio",isSpinning:!1,currentRotation:0,spinDuration:20,showSubdivisionLines:!0,showTextOnWheel:!0,connectionState:"CONNECTED",reconnectAttempt:0};function P(n){i.spinDuration=Number.parseFloat(n);const t=document.getElementById("speedValue");t&&(t.textContent=n+"s")}function K(n=!1){var o;const t=document.getElementById("itemsTableBody");if(!t)return;const e=(o=t.previousElementSibling)==null?void 0:o.querySelector("tr");if(e){const s=e.querySelector("th:last-child");s&&(s.style.display=n?"none":"")}t.innerHTML="",i.items.forEach((s,r)=>{const a=document.createElement("tr"),c=n?"disabled":"";a.innerHTML=`
      <td><input type="text" value="${s.name}" class="editable-field" data-index="${r}" data-field="name" ${c}></td>
      <td><input type="number" value="${s.quantity}" class="editable-field" data-index="${r}" data-field="quantity" ${c}></td>
      <td style="display: ${n?"none":""}">
        <button class="remove-btn" data-index="${r}">&times;</button>
      </td>
    `,t.appendChild(a)})}function tt(){const n=["#ff6b6b","#4ecdc4","#45b7d1","#feca57","#ff9ff3","#54a0ff","#5f27cd","#00d2d3","#ff9f43","#10ac84","#ee5a24","#0abde3","#7bed9f","#2e86de","#a55eea","#26de81","#fc5c65","#fd79a8"],t=i.items.map(o=>o.color),e=n.filter(o=>!t.includes(o));return e.length>0?e[Math.floor(Math.random()*e.length)]:"#"+Math.floor(Math.random()*16777215).toString(16).padStart(6,"0")}function H(){sessionStorage.setItem("rouletteItems",JSON.stringify(i.items))}function et(n){n.preventDefault();const t=document.getElementById("itemName"),e=document.getElementById("itemQuantity");if(!t||!e)return;const o=t.value.trim(),s=Number.parseInt(e.value,10);o&&s>0&&(i.items.push({name:o,quantity:s,color:tt()}),t.value="",e.value="10",t.focus(),H())}function nt(n){const t=n.target;if(t.classList.contains("remove-btn")){const e=Number.parseInt(t.dataset.index||"",10);isNaN(e)||(i.items.splice(e,1),H())}}function ot(n){const t=n.target;if(!t.classList.contains("editable-field"))return;const e=Number.parseInt(t.dataset.index||"",10),o=t.dataset.field;if(isNaN(e)||!o)return;const s=i.items[e];if(s){if(o==="name")s.name=t.value;else if(o==="quantity"){const r=Number.parseInt(t.value,10);s.quantity=isNaN(r)||r<0?0:r}H()}}function U(){if(!i.isSpinning)return;const n=document.getElementById("wheelSVG"),t=document.getElementById("result");if(!n||!t)return;const e=window.getComputedStyle(n).transform;let o=0;if(e!=="none"){const d=e.split("(")[1].split(")")[0].split(","),l=parseFloat(d[0]),u=parseFloat(d[1]);o=Math.atan2(u,l)*(180/Math.PI)}const s=(270-o%360+360)%360,r=i.items.reduce((d,l)=>d+l.quantity,0);let a=null,c=0;if(r>0)for(const d of i.items){const l=d.quantity/r*360;if(c+=l,s<c){a=d;break}}t.innerHTML=`Girando... <strong>${a?a.name:""}</strong>`,requestAnimationFrame(U)}function B(){const n=document.getElementById("wheelSVG");if(!n)return;n.innerHTML="";const t=document.createElementNS("http://www.w3.org/2000/svg","circle");t.setAttribute("cx","275"),t.setAttribute("cy","275"),t.setAttribute("r","271"),t.setAttribute("fill","none"),t.setAttribute("stroke","#2f3542"),t.setAttribute("stroke-width","8"),n.appendChild(t);const e=i.items.reduce((l,u)=>l+u.quantity,0),o=document.querySelector(".spin-button");if(e===0){o&&(o.disabled=!0);return}o&&(o.disabled=!1);const s=275,r=275,a=267;let c=0;if(i.items.forEach(l=>{const u=l.quantity/e*360,g=c,h=c+u,p=Math.PI/180*g,b=Math.PI/180*h,f=s+a*Math.cos(p),Q=r+a*Math.sin(p),J=s+a*Math.cos(b),_=r+a*Math.sin(b),Y=u>180?1:0,j=[`M ${s} ${r}`,`L ${f} ${Q}`,`A ${a} ${a} 0 ${Y} 1 ${J} ${_}`,"Z"].join(" "),N=document.createElementNS("http://www.w3.org/2000/svg","path");if(N.setAttribute("d",j),N.setAttribute("fill",l.color),n.appendChild(N),i.showTextOnWheel){const O=g+u/2,W=a*.6,q=Math.PI/180*O,G=s+W*Math.cos(q),F=r+W*Math.sin(q),m=document.createElementNS("http://www.w3.org/2000/svg","text");m.setAttribute("x",String(G)),m.setAttribute("y",String(F)),m.textContent=l.name,m.setAttribute("fill","#FFFFFF"),m.setAttribute("font-size","16"),m.setAttribute("font-weight","bold"),m.setAttribute("text-anchor","middle"),m.setAttribute("alignment-baseline","middle"),m.style.textShadow="1px 1px 2px rgba(0,0,0,0.7)",m.setAttribute("transform",`rotate(${O+0}, ${G}, ${F})`),n.appendChild(m)}c+=u}),i.showSubdivisionLines){const l=360/e;for(let u=1;u<=e;u++){const g=u*l,h=Math.PI/180*g,p=s+a*Math.cos(h),b=r+a*Math.sin(h),f=document.createElementNS("http://www.w3.org/2000/svg","line");f.setAttribute("x1",String(s)),f.setAttribute("y1",String(r)),f.setAttribute("x2",String(p)),f.setAttribute("y2",String(b)),f.setAttribute("stroke","rgba(0,0,0,0.10)"),f.setAttribute("stroke-width","1"),n.appendChild(f)}}const d=document.createElementNS("http://www.w3.org/2000/svg","circle");d.setAttribute("cx",String(s)),d.setAttribute("cy",String(r)),d.setAttribute("r",String(a*.1)),d.setAttribute("fill","#667eea"),d.setAttribute("stroke","#2f3542"),d.setAttribute("stroke-width","8"),n.appendChild(d)}function k(n=!1,t=null){if(i.isSpinning||i.items.length===0)return;const e=document.getElementById("spinButton"),o=document.getElementById("result"),s=document.getElementById("wheelSVG"),r=document.getElementById("animation-style");if(!o||!s||!r)return;let a=0,c=0;if(t)a=t.initialRotation,c=t.finalRotation;else{const l=Math.round(.2727272727272727*i.spinDuration+3.6363636363636362),u=l+2,g=Math.random()*(u-l)+l,h=Math.random()*360;a=i.currentRotation;const p=g*360+h;c=a+p}if(n)return{initialRotation:a,finalRotation:c,duration:i.spinDuration};i.isSpinning=!0,i.currentRotation=c,e&&(e.disabled=!0,e.textContent="GIRANDO..."),o.textContent="Girando...";const d=`
    @keyframes spinAnimation {
      from {
        transform: rotate(${a}deg);
      }
      to {
        transform: rotate(${c}deg);
      }
    }
  `;r.innerHTML=d,s.style.animation=`spinAnimation ${i.spinDuration}s cubic-bezier(0,-0.01,.41,1) forwards`,requestAnimationFrame(U),s.addEventListener("animationend",()=>{const l=i.items.reduce((u,g)=>u+g.quantity,0);if(l===0)o.textContent="Roda vazia!";else{const g=(270-c%360%360+360)%360;let h=null,p=0;for(const b of i.items){const f=b.quantity/l*360;if(p+=f,g<p){h=b;break}}o.innerHTML=`ðŸŽ‰ Resultado: <strong>${h?h.name:"Nenhum"}</strong>`}e&&(e.disabled=!1,e.textContent="GIRAR NOVAMENTE"),i.isSpinning=!1,s.style.transform=`rotate(${c}deg)`,s.style.animation="",r.innerHTML=""},{once:!0})}class it{constructor(t,e){A(this,"ws",null);A(this,"messageHandlers",new Map);A(this,"closeHandler",null);this.raffleId=t,this.role=e}connect(){const t=window.location.protocol==="https:"?"wss:":"ws:",e=window.location.host,o=`${t}//${e}/ws?id=${this.raffleId}&role=${this.role}`;this.ws=new WebSocket(o),this.ws.onopen=()=>{console.log("WebSocket connection established.")},this.ws.onmessage=s=>{try{const r=JSON.parse(s.data);this.messageHandlers.has(r.type)&&this.messageHandlers.get(r.type)(r.payload)}catch(r){console.error("Error processing message:",r)}},this.ws.onclose=()=>{console.log("WebSocket connection closed."),this.closeHandler&&this.closeHandler()},this.ws.onerror=s=>{console.error("WebSocket error:",s)}}on(t,e){this.messageHandlers.set(t,e)}onClose(t){this.closeHandler=t}send(t){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(t)):console.error("WebSocket is not connected.")}close(){var t;(t=this.ws)==null||t.close()}}const M=document.getElementById("configControls"),C=document.getElementById("configManager"),V=document.getElementById("raffleIdDisplay"),z=document.getElementById("roleDisplay"),E=document.getElementById("exitButton"),T=document.getElementById("syncButton"),I=document.getElementById("spinButton"),D=document.getElementById("addItemForm"),$=document.getElementById("itemsTableBody"),v=document.getElementById("showLinesCheckbox"),x=document.getElementById("showTextCheckbox"),w=document.getElementById("speedSlider"),y=document.getElementById("raffleTitleInput"),L=document.getElementById(".manager-title");let S=null;function R(n=!1){B(),K(n),y&&(y.value=i.raffleTitle)}document.addEventListener("DOMContentLoaded",()=>{console.log("DEBUG: DOM content loaded. Starting main script.");const n=sessionStorage.getItem("currentRaffleId"),t=sessionStorage.getItem("currentRaffleRole");if(console.log("DEBUG: Retrieved from sessionStorage:",{raffleId:n,role:t}),!n||!t){console.log("DEBUG: Validation FAILED. Redirecting to index.html"),window.location.href="/index.html";return}console.log("DEBUG: Validation PASSED."),history.replaceState(null,"","/raffle.html"),V&&(V.textContent=`ID do Sorteio: ${n}`),z&&(z.textContent=`Papel: ${t==="configurator"?"Configurador":"Espectador"}`),E&&(E.style.display="block"),console.log("DEBUG: Creating WebSocket client..."),S=new it(n,t),console.log("DEBUG: Attempting to connect WebSocket..."),S.connect(),E==null||E.addEventListener("click",()=>{S==null||S.close(),window.location.href="/index.html"}),t==="configurator"?st(S):rt(S),t==="configurator"&&R(!1)});function st(n){M&&(M.style.display="flex"),C&&(C.style.display="block"),L&&(L.style.display="block");const t=sessionStorage.getItem("rouletteItems");if(t)try{i.items=JSON.parse(t)}catch(e){console.error("Failed to load items from session:",e)}T==null||T.addEventListener("click",()=>{n.send({type:"SYNC_CONFIG",payload:{items:i.items,spinDuration:i.spinDuration,showSubdivisionLines:i.showSubdivisionLines,showTextOnWheel:i.showTextOnWheel,raffleTitle:i.raffleTitle}})}),I==null||I.addEventListener("click",()=>{if(i.items.length===0)return;const e=k(!0);n.send({type:"SPIN_WHEEL",payload:e}),k(!1,e)}),D==null||D.addEventListener("submit",e=>{et(e),R()}),$&&($.addEventListener("click",e=>{e.target.classList.contains("remove-btn")&&(nt(e),R())}),$.addEventListener("input",e=>{ot(e),B()})),v==null||v.addEventListener("change",()=>{i.showSubdivisionLines=v.checked,B()}),x==null||x.addEventListener("change",()=>{i.showTextOnWheel=x.checked,B()}),w==null||w.addEventListener("input",()=>{w&&P(w.value)}),w&&P(w.value),y==null||y.addEventListener("input",()=>{y&&(i.raffleTitle=y.value)})}function rt(n){I&&(I.style.display="none"),M&&(M.style.display="none"),C&&(C.style.display="none"),L&&(L.style.display="none"),y&&(y.disabled=!0);const t=document.getElementById("result");let e=!1;n.on("ERROR",o=>{e=!0,t&&(t.innerHTML=`<strong>Erro: ${o.message}. Redirecionando...</strong>`),setTimeout(()=>{window.location.href="/index.html"},3e3)}),n.on("SYNC_CONFIG",o=>{console.log("Syncing config:",o),i.items=o.items||[],i.spinDuration=o.spinDuration||20,i.showSubdivisionLines=o.showSubdivisionLines,i.showTextOnWheel=o.showTextOnWheel,i.raffleTitle=o.raffleTitle||"ðŸŽ¯ Roda de Sorteio",R(!0)}),n.on("SPIN_WHEEL",o=>{console.log("Received spin command:",o),k(!1,o)}),n.onClose(()=>{e||(t&&(t.innerHTML="<strong>A sessÃ£o foi encerrada pelo configurador. Redirecionando...</strong>"),E&&E.setAttribute("disabled","true"),setTimeout(()=>{window.location.href="/index.html"},3e3))})}
